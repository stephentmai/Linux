# Iptables
在早期的 Linux 系统中，默认使用 iptables 防火墙管理服务来配置防火墙。尽管新型的 firewalld 防火墙管理服务已经被投入使用多年，但是大量的企业依然出于各种原因而在生产环境中继续使用 iptables。考虑到 iptables 在当前生产环境中还具有顽强的生命力，以及为了使大家在求职面试过程中被问到 iptables 的相关知识时能胸有成竹，刘遄老师觉得还是有必要在本书中好好地讲解一下这项技术。更何况前文也提到，各种防火墙管理工具的配置思路是一致的，在掌握了 iptables 的配置方法后，也能够为学习其他防火墙管理工具提供有益的借鉴和参考。

iptables 防火墙会按照从上到下的顺序来读取配置的策略规则，在找到匹配项后会立即结束匹配工作并去执行匹配项中定义的行为（即允许或拒绝，也称为“放行或阻止”）。如果在读取完所有的策略规则之后没有匹配项，就去执行默认策略。通常，防火墙策略规则有两种设置：通（即允许）和堵（即拒绝）。当防火墙的默认策略为拒绝时（堵），就要设置允许规则（通），否则谁都进不来；如果防火墙的默认策略为允许（通），就要设置拒绝规则（堵），否则谁都能进来，防火墙也就失去了防范的作用。

iptables 服务把用于处理或过滤流量的策略条目称之为规则，多条规则可以组成一个规则链，而规则链则依据数据包处理位置的不同进行分类，具体如下：

在进行路由选择前处理数据包（PREROUTING）；

处理流入的数据包（INPUT）；

处理流出的数据包（OUTPUT）；

处理转发的数据包（FORWARD）；

在进行路由选择后处理数据包（POSTROUTING）。

一般来说，从内网向外网发送的流量通常是可控且良性的，因此使用最多的就是 INPUT规则链，该规则链可以增大黑客人员从外网入侵内网的难度。

举例来说，在你居住的社区内，物业管理公司有两条规则：禁止小商小贩进入社区； 各种车辆在进入社区时都要登记。显而易见，这两条规定应该是用于社区的正门（流量必 须经过的地方），而不是每家每户的防盗门上。根据前面提到的防火墙策略的匹配顺序，可能会存在多种情况。例如，来访人员是小商小贩，则会直接被物业公司的保安拒之门外， 也就无须再对车辆进行登记。如果来访人员乘坐一辆汽车进入社区正门，则“禁止小商小 贩进入社区”的第一条规则就没有被匹配到，因此按照顺序匹配第二条规则，即需要对车 辆进行登记。如果是社区居民要进入正门，则这两条规定都不会匹配到，因此会执行默认 的允许策略。

但是，仅有策略规则还不能保证社区的安全，保安还应该知道该采用什么样的动作来处理这些匹配的流量，比如“允许”“拒绝”“登记”“不理它”。这些动作对应到 iptables 服务的术语中分别是 ACCEPT（允许流量通过）、REJECT（拒绝流量通过）、LOG（记录日志信息）、DROP（拒绝流量通过）。“允许流量通过”和“记录日志信息”都比较好理解，这里需要着重讲解的是 REJECT 和 DROP 的不同点。就 DROP 来说，它是直接将流量丢弃而且不响应；REJECT 则会在拒绝流量后再回复一条“信息已经收到，但是被扔掉了”信息，从而让流量发送方清晰地看到数据被拒绝的响应信息。

下面举一个例子，让各位读者更直观地理解这两个拒绝动作的不同之处。比如有一天你正在家里看电视，突然听到有人敲门，透过防盗门的猫眼一看是推销商品的，便会在不需要的情况下开门并拒绝他们（REJECT）。但如果看到的是债主带了十几个小弟来讨债，此时不仅要拒绝开门，还要默不作声，伪装成自己不在家的样子（DROP）。

当把 Linux 系统中的防火墙策略设置为 REJECT 动作后，流量发送方会看到“端口不可达”的响应：
```shell
root@linuxprobe:~# ping -c 4 192.168.10.10
PING 192.168.10.10 (192.168.10.10) 56(84) bytes of data.
From 192.168.10.10 icmp_seq=1 Destination Host Unreachable
From 192.168.10.10 icmp_seq=2 Destination Host Unreachable
From 192.168.10.10 icmp_seq=3 Destination Host Unreachable
From 192.168.10.10 icmp_seq=4 Destination Host Unreachable

--- 192.168.10.10 ping statistics ---
4 packets transmitted, 0 received, +4 errors, 100% packet loss, time 3099ms
pipe 4
```
而把 Linux 系统中的防火墙策略修改成 DROP 动作后，流量发送方会看到“响应超时” 的提醒。但是流量发送方无法判断流量是被拒绝，还是接收方主机当前不在线：
```shell
root@linuxprobe:~# ping -c 4 192.168.10.10
PING 192.168.10.10 (192.168.10.10) 56(84) bytes of data.

--- 192.168.10.10 ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 3000ms
```
根据 OSI 七层模型的定义，iptables 属于工作在第二、三、四层的服务，所以能够根据流量的源地址、目的地址、传输协议、服务类型等信息进行匹配；一旦匹配成功，iptables 就会根据策略规则所预设的动作来处理这些流量。另外，再次提醒一下，防火墙策略规则的匹配顺序是从上到下的，因此要把较为严格、优先级较高的策略规则放到前面，以免发生错误。表 8-1 总结归纳了 iptables 命令的常用参数以及作用。再次强调，无须死记硬背这些参数，需要时来翻回来查阅即可。

由于本书是基于红帽 RHEL 10 系统编写的，该系统当前已不再适配 iptables 防火墙管理工具，在对 iptables 命令进行实操时，可以找老版本的 RHEL 系统进行操作。

**iptables 命令的常用参数以及作用**

|    参数     |                       作用                        |
| :---------: | :-----------------------------------------------: |
|     -P      |                   设置默认策略                    |
|     -F      |                    清空规则链                     |
|     -L      |                    查看规则链                     |
|     -A      |             在规则链的末尾添加新规则              |
|   -I num    |             在规则链的头部添加新规则              |
|   -D num    |                   删除指定规则                    |
|     -s      | 匹配来源地址（IP/MASK），加叹号（!）表示排除该 IP |
|     -d      |                   匹配目的地址                    |
|     -i      |         网卡名称	匹配从指定网卡流入的数据         |
|     -o      |         网卡名称	匹配从指定网卡流出的数据         |
|     -p      |            匹配协议，如 TCP、UDP、ICMP            |
| --dport num |                  匹配目的端口号                   |
| --sport num |                  匹配来源端口号                   |