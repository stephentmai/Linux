# 服务的访问控制列表
TCP Wrapper 是RHEL 5/6 系统中默认启用的一款服务访问控制程序，它能够根据来访主机的地址与本机的目标服务程序做出允许或拒绝的操作。在 RHEL 10 版本中，它已经被firewalld 正式替代。换句话说，Linux 系统中其实有两个层面的防火墙，第一个是前面讲到的基于TCP/IP 的流量过滤工具，而 TCP Wrapper 服务则是能允许或禁止 Linux 系统提供服务的防火墙，可以在更高层面保护Linux 系统的安全运行。

TCP Wrapper 服务的防火墙策略由两个控制列表文件所控制，用户可以编辑允许控制列表文件来放行对服务的请求流量，也可以编辑拒绝控制列表文件来阻止对服务的请求流量。控制列表文件修改后会立即生效，系统将先检查允许控制列表文件（/etc/hosts.allow），如果匹配到相应的允许策略则放行流量；如果没有匹配，则会进一步匹配拒绝控制列表文件（/etc/hosts.deny），若找到匹配项则拒绝该流量。如果这两个文件都没有匹配到，则默认放行流量。

由于RHEL 10 版本已经不再支持TCP Wrapper 服务程序，因此我们接下来选择在一台老版本的服务器上进行实验。TCP Wrapper 服务的控制列表文件配置起来并不复杂，常用的客户端地址匹配模式如表 8-4 所示。

**TCP Wrappers 服务的控制列表文件中常用的客户端地址匹配模式**

| 客户端地址匹配模式 |            示例            |        满足示例的客户端列表         |
| :----------------: | :------------------------: | :---------------------------------: |
|      单一主机      |       192.168.10.10        |   IP 地址为 192.168.10.10 的主机    |
|      指定网段      |        192.168.10.         |   IP 段为 192.168.10.0/24 的主机    |
|      指定网段      | 192.168.10.0/255.255.255.0 |   IP 段为 192.168.10.0/24 的主机    |
|   指定 DNS 后缀    |      .linuxprobe.com       | 所有DNS后缀为.linuxprobe.com的主机  |
|    指定主机名称    |     www.linuxprobe.com     | 主机名称为www.linuxprobe.com 的主机 |
|   指定所有客户端   |            ALL             |        所有主机全部包括在内         |

在配置 TCP Wrapper 服务时需要遵循两个原则：

编写拒绝策略规则时，填写的是服务名称，而非协议名称；
建议先编写拒绝策略规则，再编写允许策略规则，以便直观地看到相应的效果。
下面编写拒绝策略规则文件，禁止访问本机 sshd 服务的所有流量（无须修改/etc/hosts.deny 文件中原有的注释信息）：
```shell
root@linuxprobe:~# vim /etc/hosts.deny
#
# hosts.deny This file contains access rules which are used to
# deny connections to network services that either use
# the tcp_wrappers library or that have been
# started through a tcp_wrappers-enabled xinetd.
#
# The rules in this file can also be set up in
# /etc/hosts.allow with a 'deny' option instead.
#
# See 'man 5 hosts_options' and 'man 5 hosts_access'
# for information on rule syntax.
# See 'man tcpd' for information on tcp_wrappers
sshd:*
root@linuxprobe:~# ssh 192.168.10.10
ssh_exchange_identification: read: Connection reset by peer
```
接下来，在允许策略规则文件中添加一条规则，使其放行源自 192.168.10.0/24 网段， 且访问本机sshd 服务的所有流量。可以看到，服务器立刻就放行了访问sshd 服务的流量，效果非常直观：
```shell
root@linuxprobe:~# vim /etc/hosts.allow
#
# hosts.allow This file contains access rules which are used to
# allow or deny connections to network services that
# either use the tcp_wrappers library or that have been
# started through a tcp_wrappers-enabled xinetd.
#
# See 'man 5 hosts_options' and 'man 5 hosts_access'
# for information on rule syntax.
# See 'man tcpd' for information on tcp_wrappers
sshd:192.168.10.

root@linuxprobe:~# ssh 192.168.10.10
The authenticity of host '192.168.10.10 (192.168.10.10)' can't be established.
ECDSA key fingerprint is 70:3b:5d:37:96:7b:2e:a5:28:0d:7e:dc:47:6a:fe:5c.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.10.10' (ECDSA) to the list of known hosts.
root@192.168.10.10's password: 此处输入root管理员密码
Last login: Wed May 4 07:56:29 2025
root@linuxprobe:~# 
```