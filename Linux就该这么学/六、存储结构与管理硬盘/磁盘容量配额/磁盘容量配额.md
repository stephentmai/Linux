# 磁盘容量配额
前面提到，Linux 系统的设计初衷就是让许多人一起使用并执行各自的任务，从而成为多用户、多任务的操作系统。但是，硬件资源是固定且有限的，如果某些用户不断地在 Linux 系统上创建文件或存放大的视频文件，磁盘空间总有一天会被占满。针对这种情况，root 管理员可以使用磁盘容量配额服务来限制某位用户或某个用户组在特定文件夹中能够使用的最大磁盘空间或最大文件个数。一旦达到这个最大值，就不再允许继续使用。可以使用 quota 技术进行磁盘容量配额管理，从而限制用户的磁盘可用容量或所能创建的最大文件个数。quota 技术还有软限制和硬限制的功能。

软限制：当达到软限制时会提示用户，但仍允许用户在限定的额度内继续使用。

硬限制：当达到硬限制时会提示用户，且强制终止用户的操作。

RHEL 10 系统中已经安装了quota 磁盘容量配额服务程序包，但存储设备默认没有开启对 quota 技术的支持。此时需要手动编辑配置文件并重启一次系统，让系统中的启动目录（/boot）支持 quota 磁盘配额技术。
```shell
root@linuxprobe:~# vim /etc/fstab
#
# /etc/fstab
# Created by anaconda on Wed Mar 12 19:35:26 2025
#
# Accessible filesystems, by reference, are maintained under '/dev/disk/'.
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info.
#
# After editing this file, run 'systemctl daemon-reload' to update systemd
# units generated from this file.
#
UUID=408f4a3d-a4d3-4a44-bb23-6988cdbd10bf /             xfs     defaults        0 0
UUID=4cf8ecae-bcb6-4b1e-8001-968b33643a8a /boot         xfs     defaults,uquota 0 0
UUID=1FB8-9199          /boot/efi               vfat    umask=0077,shortname=winnt 0 2
UUID=d936c726-45a7-4ca2-8932-c54f84a3d787 none          swap    defaults        0 0
/dev/cdrom 				/media/cdrom 					iso9660 defaults 		0 0
/dev/sdb1  				/newFS       					xfs     defaults 		0 0
/dev/sdb2				swap							swap	defaults		0 0
root@linuxprobe:~# reboot
```
Tips ：
在实操中发现，VMware Workstation 17 Pro 虚拟机系统有时会错误地混淆两块磁盘， 导致重启后系统开机失败。可将/etc/fstab 文件中/dev/sdb2 设备的挂载信息删除， 或使用 UUID 挂载，再次重启就一切正常了。

另外，对于学习过早期的 Linux 系统，或者具有 RHEL 5/6 系统使用经验的读者来说，这里需要特别注意。早期的 Linux 系统要想让磁盘设备支持 quota 磁盘容量配额服务，使用的是 usrquota 参数，而 RHEL 7 以及以后的版本使用的则是uquota 参数。

在重启系统后使用 mount 命令查看，即可发现/boot 目录已经支持 quota 磁盘配额技术了：
```shell
root@linuxprobe:~# mount | grep boot
/dev/sda2 on /boot type xfs (rw,relatime,seclabel,attr2,inode64,logbufs=8,logbsize=32k,usrquota)
```
接下来创建一个用于检查 quota 磁盘容量配额效果的用户 tom，并针对/boot 目录增加其他人的写权限，保证用户能够正常写入数据：
```shell
root@linuxprobe:~# useradd tom
root@linuxprobe:~# chmod -R o+w /boot
```
xfs_quota 命令用于管理XFS 格式设备的磁盘容量配额，语法格式为“xfs_quota [参数] 配额 挂载点”。

这是一个专为管理 XFS 文件系统磁盘容量配额（quota）而设计的命令。其中，-c 参数用于以参数的形式设置要执行的命令；-x 参数是专家模式，让运维人员能够对 quota 服务进行更多复杂的配置。

接下来使用 xfs_quota 命令设置用户 tom 对/boot 目录的 quota 磁盘容量配额。具体的限额控制包括：磁盘使用量的软限制和硬限制分别为 3MB 和 6MB；创建文件数量的软限制和硬限制分别为 3 个和 6 个。
```shell
root@linuxprobe:~# xfs_quota -x -c 'limit bsoft=3m bhard=6m isoft=3 ihard=6 tom' /boot
root@linuxprobe:~# xfs_quota -x -c report /boot
User quota on /boot (/dev/sda2)
                               Blocks                     
User ID          Used       Soft       Hard    Warn/Grace     
---------- -------------------------------------------------- 
root           225552          0          0     00 [--------]
tom                 0       3072       6144     00 [--------]
```
上面使用的参数分为两组，分别是 isoft/ihard 与 bsoft/bhard，下面深入讲解一下。6.3 节曾经讲过，Linux 系统中的每个文件都会使用一个独立的 inode 信息块来保存属性信息，一个文件对应一个 inode 信息块，所以 isoft 和 ihard 就是通过限制系统最大使用的 inode 个数来限制文件数量。bsoft 和bhard 则是代表文件所占用的block 大小，也就是文件占用的最大容量的总和。

soft 是软限制，超过该限制后系统也只是将操作记录写到日志中，不对用户行为进行限制。而 hard 是硬限制，一旦超过该限制，系统就会马上禁止，用户再也不能创建或新占任何的磁盘容量。

当配置好上述各种软硬限制后，尝试切换到一个普通用户，然后分别尝试创建一个体积为 5MB 和 8MB 的文件。可以发现，在创建 8MB 的文件时受到了系统限制：
```shell
root@linuxprobe:~# su - tom
tom@linuxprobe:~$ cd /boot
tom@linuxprobe:/boot$ dd if=/dev/zero of=/boot/tom bs=5M count=1
1+0 records in
1+0 records out
5242880 bytes (5.2 MB, 5.0 MiB) copied, 0.00163334 s, 3.2 GB/s
tom@linuxprobe:/boot$ dd if=/dev/zero of=/boot/tom bs=8M count=1
dd: error writing '/boot/tom': Disk quota exceeded
1+0 records in
0+0 records out
4194304 bytes (4.2 MB, 4.0 MiB) copied, 0.00370067 s, 1.1 GB/s
```
在为用户设置了 quota 磁盘容量配额限制后，可以使用 edquota 命令按需修改限额的数值。edquota 命令主要用于管理系统的磁盘配额，英文全称为 edit quota，语法格式为“edquota [参数] 用户名”。其中，-u 参数表示要针对哪个用户进行设置；-g 参数表示要针对哪个用户组进行设置。

edquota 命令中可用的参数以及作用如表 6-6 所示。

**edquota 命令中可用的参数以及作用**

| 参数  |            作用             |
| :---: | :-------------------------: |
|  -u   |     对某个用户进行设置      |
|  -g   |    对某个用户组进行设置     |
|  -p   | 复制原有的规则到新的用户/组 |
|  -t   |        限制宽限期限         |

edquota 命令会调用 Vi 或 Vim 编辑器让root 管理员修改要限制的具体细节，记得用 wq 保存退出。下面把用户 tom 的磁盘使用量的硬限额从 5MB 提升到 8MB：
```shell
tom@linuxprobe:/boot$ exit
root@linuxprobe:~# edquota -u tom
Disk quotas for user tom (uid 1001):
  Filesystem                   blocks       soft       hard     inodes     soft     hard
  /dev/sda2                      4096       3072       8192          1        3        6
root@linuxprobe:~# su - tom
tom@linuxprobe:~$ cd /boot
tom@linuxprobe:/boot$ dd if=/dev/zero of=/boot/tom bs=8M count=1
1+0 records in
1+0 records out
8388608 bytes (8.4 MB, 8.0 MiB) copied, 0.00644861 s, 1.3 GB/s
tom@linuxprobe:/boot$ exit
```