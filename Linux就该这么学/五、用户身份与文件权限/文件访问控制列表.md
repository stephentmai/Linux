# 文件访问控制列表
不知道大家是否发现，前文讲解的一般权限、特殊权限、隐藏权限其实有一个共性—权限是针对某一类用户设置的，即对很多人同时生效。如果希望对某个指定的用户进行单独的精准权限控制，就需要用到文件的访问控制列表（ACL）了。通俗来讲，基于普通文件或目录设置 ACL 其实就是针对指定的用户或用户组设置文件或目录的操作权限，从而更加精准地派发权限。另外，如果针对某个目录设置了 ACL，则目录中的文件会继承其 ACL 权限；若针对文件设置了 ACL，则文件不再继承其所在目录的ACL 权限。

为了直观查看 ACL 对文件权限控制的强大效果，我们先切换到普通用户，然后尝试进入root 管理员的家目录中。在没有针对普通用户为 root 管理员的家目录设置 ACL 之前，其执行结果如下所示：
```shell
root@linuxprobe:~# su - linuxprobe
linuxprobe@linuxprobe:~$ cd /root
-bash: cd: /root: Permission denied
linuxprobe@linuxprobe:~$ exit
```
## setfacl 命令

setfacl 命令用于管理文件的 ACL 权限规则，英文全称为 set file access control lists (ACL)， 语法格式为“setfacl [参数] 文件名”。

ACL 权限提供的是在所有者、所属组、其他人的可读/可写/可执行权限之外的特殊权限控制。使用 setfacl 命令可以针对单一用户或用户组、单一文件或目录来进行可读/可写/ 可执行权限的控制。其中，针对目录文件需要使用-R 递归参数；针对普通文件则使用-m 参数；如果想要删除某个文件的 ACL，则可以使用-b 参数。setfacl 命令的常用参数以及作用如表 5-9 所示。

**setfacl 命令的常用参数以及作用**

| 参数  |       作用       |
| :---: | :--------------: |
|  -m   |     修改权限     |
|  -M   | 从文件中读取权限 |
|  -x   |   删除某个权限   |
|  -b   |   删除全部权限   |
|  -R   |    递归子目录    |

例如，我们原本无法进入/root 目录中，现在为普通用户单独设置一下权限：
```shell
root@linuxprobe:~# setfacl -Rm u:linuxprobe:rwx /root
```
随后再切换到这位普通用户的身份下，现在就能正常进入了：
```shell
root@linuxprobe:~# su - linuxprobe
linuxprobe@linuxprobe:~$ cd /root
linuxprobe@linuxprobe:/root$ ls
anaconda-ks.cfg  Documents  Music     Public     Videos
Desktop          Downloads  Pictures  Templates
linuxprobe@linuxprobe:/root$ exit
```
是不是觉得效果很酷呢？但是现在有这样一个小问题—怎么去查看文件是否设置了ACL 呢？常用的 ls 命令是看不到 ACL 信息的，但是却可以看到文件权限的最后一个点（.） 变成了加号（+），这就意味着该文件已经设置了 ACL。现在大家是不是感觉学得越多，越不敢说自己精通 Linux 系统了吧？就这么一个不起眼的点（.），竟然还表示这么一种重要的权限。
```shell
root@linuxprobe:~# ls -ld /root
dr-xrwx---+ 14 root root 4096 Mar 13 13:22 /root
```
## getfacl 命令

getfacl 命令用于查看文件的 ACL 权限规则，英文全称为 get file access control lists， 语法格式为“getfacl [参数] 文件名称”。

Linux 系统中的命令就是这么又可爱又好记。想要设置 ACL，用的是 setfacl 命令；要想查看 ACL，则用的是 getfacl 命令。下面使用 getfacl 命令显示在 root 管理员家目录上设置的所有 ACL 信息：
```shell
root@linuxprobe:~# getfacl /root
getfacl: Removing leading '/' from absolute path names
# file: root
# owner: root
# group: root
user::r-x
user:linuxprobe:rwx
group::r-x
mask::rwx
other::---
```
还可以针对某个用户组设置 ACL 权限。例如，允许某个组的用户读写/etc/fstab 文件：
```shell
root@linuxprobe:~# setfacl -m g:linuxprobe:rw /etc/fstab
root@linuxprobe:~# getfacl /etc/fstab 
getfacl: Removing leading '/' from absolute path names
# file: etc/fstab
# owner: root
# group: root
user::rw-
group::r--
group:linuxprobe:rw-
mask::rw-
other::r--
```
设置错了想删除？没问题！要清空所有 ACL 权限，请用-b 参数；要删除某一条指定的权限，就用-x 参数：
```shell
root@linuxprobe:~# setfacl -x g:linuxprobe /etc/fstab
root@linuxprobe:~# getfacl /etc/fstab 
getfacl: Removing leading '/' from absolute path names
# file: etc/fstab
# owner: root
# group: root
user::rw-
group::r--
mask::r--
other::r--
```
ACL 权限的设置都是立即且永久生效的，不需要再编辑什么配置文件，这一点特别方便。但是，这也带来了一个安全隐患，即如果不小心设置错了权限，就会覆盖掉文件原始的权限信息，并且永远都找不回来了。

操作前备份一下，总是好的习惯

例如，在备份/home 目录上的 ACL 权限时，可使用-R 递归参数，这样不仅能够把目录本身的权限进行备份，还能将里面的文件权限也自动备份。另外，再加上第 3 章学习过的输出重定向操作，可轻松实现权限的备份。需要注意，getfacl 在备份目录权限时不能使用绝对路径的形式，因此我们需要先切换到最上层根目录，然后再进行操作。
```shell
root@linuxprobe:~# cd /
root@linuxprobe:/# getfacl -R home > backup.acl
root@linuxprobe:/# ls -l backup.acl
-rw-r--r--. 1 root root 945 Mar 13 13:24 backup.acl
```
ACL 权限的恢复也很简单，使用的是--restore 参数。由于在备份时已经指定是对 /home 目录进行操作，所以不需要写对应的目录名称，它能够自动找到要恢复的对象：
```shell
root@linuxprobe:/# setfacl --restore backup.acl
```