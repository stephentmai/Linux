# 计划任务服务程序
经验丰富的系统运维工程师能够使 Linux 在无人干预的情况下，在指定的时间段自动启用或停止某些服务或命令，从而实现运维的自动化。尽管我们现在已经有了功能彪悍的脚本程序来执行一些批处理工作，但是，如果仍然需要在每天凌晨两点敲击键盘回车键来执行这个脚本程序，就太痛苦了（当然，也可以训练你的小猫在半夜按下回车键）。接下来，将向大家介绍如何设置服务器的计划任务服务，把周期性、规律性的工作交给系统自动完成。

计划任务分为一次性计划任务与长期性计划任务，大家可以按照如下方式理解。

一次性计划任务：今晚 23:30 重启网站服务。

长期性计划任务：每周一的凌晨 3:25 把/home/wwwroot 目录打包备份为backup.tar.gz。

顾名思义，一次性计划任务只执行一次，一般用于临时的工作需求。可以用 at 命令实现这种功能，只需要写成“at 时间”的形式就行。如果想要查看已设置好但还未执行的一次性计划任务，可使用 at -l 命令；要想将其删除，可使用“atrm 任务序号”。at 命令的参数及其作用如表 4-6 所示。
**at 命令的参数及其作用**

| 参数  |          作用          |
| :---: | :--------------------: |
|  -f   | 指定包含命令的任务文件 |
|  -q   |     指定新任务名称     |
|  -l   |  显示待执行任务的列表  |
|  -d   |  删除指定的待执行任务  |
|  -m   | 任务执行后向用户发邮件 |

在使用 at 命令、设置一次性计划任务时，默认采用的是交互式方法。例如，使用下述命令将系统设置为今晚 23:30 自动重启网站服务。
```shell
root@linuxprobe:~# at 23:30
warning: commands will be executed using /bin/sh
at Thu Mar 13 23:30:00 2025
at> systemctl restart httpd
at> 此处请同时按下<Ctrl>+<d>组合键来结束编写计划任务
job 1 at Thu Mar 13 23:30:00 2025
root@linuxprobe:~# at -l
1	Thu Mar 13 23:30:00 2025 a root
```
看到 warning 信息不要慌，at 命令只是在告诉我们接下来的任务将由 sh 解释器负责执行。这与此前学习的 Bash 解释器基本一致，不需要有额外的操作。

另外，如果大家想挑战一下难度更大但简捷性更高的方式，可以把前面学习的管道符（任意门）放到两条命令之间，让 at 命令接收前面 echo 命令的输出信息，以达到通过非交互式的方式创建计划一次性任务的目的。
```shell
root@linuxprobe:~# echo "systemctl restart httpd" | at 23:30
warning: commands will be executed using /bin/sh
job 2 at Thu Mar 13 23:30:00 2025
root@linuxprobe:~# at -l
1	Thu Mar 13 23:30:00 2025 a root
2	Thu Mar 13 23:30:00 2025 a root
```
上面设置了两条一样的计划任务，可以使用 atrm 命令轻松删除其中一条：
```
root@linuxprobe:~# atrm 2
root@linuxprobe:~# at -l
1	Thu Mar 13 23:30:00 2025 a root
```
还有些时候，我们希望 Linux 系统能够周期性、有规律地执行某些具体的任务，那么 Linux 系统中默认启用的 crond 服务简直再适合不过了。创建、编辑计划任务的命令为 crontab -e， 查看当前计划任务的命令为 crontab -l，删除某条计划任务的命令为 crontab -r。另外， 如果以管理员身份登录系统，还可以在 crontab 命令中加上-u 参数来编辑他人的计划任务。crontab 命令的参数及其作用如表 4-7 所示。
**crontab 命令的参数及其作用**
| 参数  |     作用     |
| :---: | :----------: |
|  -e   | 编辑计划任务 |
|  -u   | 指定用户名称 |
|  -l   | 列出任务列表 |
|  -r   | 删除计划任务 |

在正式部署计划任务前，请先跟刘遄老师念一下口诀“分、时、日、月、星期 命令”。这是使用 crond 服务设置任务的参数格式（其格式见表 4-8）。需要注意的是，如果有些字段没有设置，则需要使用星号（*）占位，如图 4-26 所示。

![](img/图2025-12-05-00-46-01.png)
使用 crond 设置任务的参数格式

表4-8 使用crond设置任务的参数字段说明

| 字段  |                      说明                      |
| :---: | :--------------------------------------------: |
| 分钟  |              取值为 0～59 的整数               |
| 小时  |            取值为 0～23 的任意整数             |
| 日期  |            取值为 1～31 的任意整数             |
| 月份  |            取值为 1～12 的任意整数             |
| 星期  | 取值为 0～7 的任意整数，其中 0 与 7 均为星期日 |
| 命令  |             要执行的命令或程序脚本             |

假设在每周一、三、五的凌晨 3:25，都需要使用 tar 命令把某个网站的数据目录进行打包处理，使其作为一个备份文件。可以使用 crontab -e 命令来创建计划任务，为自己创建计划任务时无须使用-u 参数。crontab –e 命令的具体实现效果和 crontab -l 命令的效果如下所示。
```shell
root@linuxprobe:~# crontab -e
root@linuxprobe:~# crontab -l
25 3 * * 1,3,5 /usr/bin/tar -czvf backup.tar.gz /home/wwwroot
```
需要说明的是，除了用逗号（,）来分别表示多个时间段，例如“8,9,12”表示 8 月、9 月和 12 月，还可以用减号（-）来表示一段连续的时间周期（例如字段“日”的取值为“12-15”，则表示每月的 12～15 日）。此外，还可以用除号（/）表示执行任务的间隔时间（例如“*/2”表示每隔 2 分钟执行一次任务）。

如果需要在 crond 服务中同时包含多条计划任务的命令语句，应每行仅写一条。例如我们再添加一条计划任务，它的功能是每周一至周五的凌晨 1 点自动清空/tmp 目录内的所有文件。尤其需要注意的是，在 crond 服务的计划任务参数中，所有命令一定要用绝对路径的方式来写，如果不知道绝对路径，请用 whereis 命令进行查询。rm 命令的路径为下面输出信息中的加粗部分。
```shell
root@linuxprobe:~# whereis rm
rm: /usr/bin/rm /usr/share/man/man1/rm.1.gz
root@linuxprobe:~# crontab -e
root@linuxprobe:~# crontab -l
25 3 * * 1,3,5 /usr/bin/tar -czvf backup.tar.gz /home/wwwroot
0  1 * * 1-5   /usr/bin/rm -rf /tmp/*
```
总结一下使用计划服务的注意事项。

在 crond 服务的配置参数中，一般会像 Shell 脚本那样以#号开头写上注释信息，这样在日后回顾这段命令代码时可以快速了解其功能、需求以及编写人员等重要信息。
计划任务中的“分”字段必须有数值，绝对不能为空或是*号，而“日”和“星期” 字段不能同时使用，否则就会发生冲突。
删除crond 计划任务则非常简单，直接使用 crontab -e 命令进入编辑界面，删除里面的文本信息即可。也可以使用 crontab -r 命令直接进行清空所有计划任务， 系统会在清空之前备份一份到/root 目录下：
```shell
root@linuxprobe:~# crontab -r
Backup of root's previous crontab saved to /root/.cache/crontab/crontab.bak
root@linuxprobe:~# crontab -l
no crontab for root
```
最后再啰嗦一句，想必读者也已经发现了，诸如 crond 在内的很多服务默认调用的是Vim 编辑器，相信大家现在能进一步体会到在 Linux 系统中掌握 Vim 文本编辑器的好处了吧。请大家一定要在彻底掌握 Vim 编辑器之后再学习下一章。